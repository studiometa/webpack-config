const path = require('path');
const chalk = require('chalk');
const instance = require('browser-sync').create();

let WATCH_HANDLERS_BINDED = false;

const getConfig = (metaConfig) => {
  const browserSyncConfig = {
    open: false,
    logPrefix: '',
    logFileChanges: false,
    logLevel: 'silent',
    notify: {
      styles: [
        'z-index: 99999998',
        'position: fixed',
        'right: 1em',
        'bottom: 1em',
        'display: none',
        'padding: 0.6em 0.8em 0.7em',
        'margin: 0',
        'font-family: JetBrains Mono, Fira Code, monospace',
        'font-size: 12px',
        'font-weight: 400',
        'text-align: center',
        'color: white',
        'background-color: #1B2032',
        'border-radius: 5px',
        'text-transform: capitalize',
      ],
    },
  };

  if (metaConfig.server && typeof metaConfig.server !== 'function') {
    browserSyncConfig.server = metaConfig.server;
  } else {
    const APP_HOST = process.env.APP_HOST || process.env.APP_HOSTNAME;
    browserSyncConfig.proxy = APP_HOST;
  }

  if (metaConfig.watch && !WATCH_HANDLERS_BINDED) {
    WATCH_HANDLERS_BINDED = true;
    metaConfig.watch.forEach((glob) => {
      if (Array.isArray(glob) && glob.length >= 2) {
        const [fileGlob, callback] = glob;
        if (typeof callback !== 'function') {
          throw new Error(
            'A watch item should implement the following schema: [glob:string, callback:function]'
          );
        }
        instance.watch(fileGlob, (event, file) => {
          callback(event, file, instance, browserSyncConfig);
        });
      } else {
        instance.watch(glob).on('change', instance.reload);
      }
    });
  }

  // Enable `https://` with browserSync
  if (
    process.env.APP_SSL &&
    process.env.APP_SSL === 'true' &&
    process.env.APP_SSL_CERT &&
    process.env.APP_SSL_KEY
  ) {
    if (browserSyncConfig.proxy) {
      browserSyncConfig.proxy = `https://${browserSyncConfig.proxy}`;
    }
    browserSyncConfig.https = {
      cert: path.resolve(process.env.APP_SSL_CERT),
      key: path.resolve(process.env.APP_SSL_KEY),
    };
  }

  if (typeof metaConfig.server === 'function') {
    metaConfig.server(browserSyncConfig, instance);
  }

  return browserSyncConfig;
};

/**
 * Get the URL generated by the BrowserSync config.
 * @param {BrowserSync} bs     The BrowserSync instance.
 * @param {Object}      config The BrowserSync config.
 */
function getUrl(bs, config) {
  const port = bs.getOption('port');
  const proxy = bs.getOption('proxy');
  const protocol = config.https ? 'https://' : 'http://';
  const target = proxy ? proxy.get('target') : `${protocol}localhost`;

  return `${target}:${port}`;
}

module.exports = (metaConfig) => ({
  instance,
  config: getConfig(metaConfig),
  get getInfo() {
    return () => {
      if (!instance.active) {
        return ['Application not running.'];
      }

      const additionalInfos = this.config.infos || [];
      const messages = [
        `Application running at ${chalk.blue(getUrl(instance, this.config))}`,
        ...additionalInfos.map((info) => {
          if (typeof info === 'function') {
            return info(getUrl(instance, this.config), this);
          }

          return info;
        }),
      ];

      // Append a line break to the last message
      if (!messages[messages.length - 1].endsWith('\n')) {
        messages[messages.length - 1] += '\n';
      }

      return messages;
    };
  },
});
